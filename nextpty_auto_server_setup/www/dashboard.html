{% extends "templates/base.html" %}

{% block title %}Dashboard{% endblock %}

{% block head_include %}
{% endblock %}

{% block content %}
<!-- Sidebar Layout -->
<div class="container-fluid">
    <div class="row" style="height:100vh">
        <!-- Sidebar (Adjustable width on small screens) -->
        <div class="col-md-3 col-lg-2 p-0 sidebar bg-dark">
            <div class="list-group">
                <a href="#allSites" class="list-group-item list-group-item-action" id="allSitesLink">My All Sites</a>
                <a href="#createNewSite" class="list-group-item list-group-item-action" id="createNewSiteLink">Create New Site</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 content" style="height: 100vh;">
            <h2>Dashboard</h2>
            
            <div id="allSites" class="tab-content" style="height: 100vh;">
                <h4>All Sites</h4>
                <table class="table table-bordered" id="sitesTable">
                    <thead>
                        <tr>
                            <th>Site Name</th>
                            <th>Status</th>
                            <th>Subscription</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic data will be inserted here -->
                    </tbody>
                </table>
            </div>

            <div id="createNewSite" class="tab-content" style="display:none; height: 100vh;">
                <iframe src="signup.html" width="100%" height="100vh" frameborder="0" style="height: 100vh;">
                    Your browser does not support iframes.
                </iframe>
            </div>
        </div>
    </div>
</div>

<script>
    const apiUrl = "/api/resource/Site"; // Replace with your actual Frappe API URL

    // Fetch sites data and display it in the table
    function fetchSiteData() {
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const sitesTableBody = document.querySelector("#sitesTable tbody");
                sitesTableBody.innerHTML = ""; // Clear existing data
                data.data.forEach(site => {
                    const row = `
                        <tr>
                            <td>${site.site_name}</td>
                            <td>${site.status}</td>
                            <td>${site.subscription}</td>
                        </tr>
                    `;
                    sitesTableBody.innerHTML += row;
                });
            })
            .catch(error => console.error("Error fetching site data:", error));
    }

    // Handle menu clicks to switch between tabs
    document.getElementById("allSitesLink").addEventListener("click", function() {
        document.getElementById("allSites").style.display = "block";
        document.getElementById("createNewSite").style.display = "none";
        fetchSiteData();
    });

    document.getElementById("createNewSiteLink").addEventListener("click", function() {
        document.getElementById("createNewSite").style.display = "block";
        document.getElementById("allSites").style.display = "none";
    });

    // Handle new site form submission
    document.getElementById("newSiteForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const siteName = document.getElementById("siteName").value;
        const status = document.getElementById("status").value;
        const subscription = document.getElementById("subscription").value;

        // POST request to create a new site via Frappe API
        const postData = {
            site_name: siteName,
            status: status,
            subscription: subscription
        };

        fetch(apiUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer your_api_token"  // Add your authentication here
            },
            body: JSON.stringify(postData)
        })
            .then(response => response.json())
            .then(data => {
                console.log("Site created:", data);
                alert("New site created successfully!");
                fetchSiteData();  // Reload the site list
                document.getElementById("newSiteForm").reset();
                document.getElementById("createNewSite").style.display = "none";
                document.getElementById("allSites").style.display = "block";
            })
            .catch(error => {
                console.error("Error creating site:", error);
                alert("Failed to create site.");
            });
    });

    fetchSiteData();
</script>
{% endblock %}
